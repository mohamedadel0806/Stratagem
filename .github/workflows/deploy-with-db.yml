name: Option A - Deploy with Full DB Restore (GHCR)

on:
  workflow_dispatch:
    inputs:
      export_path:
        description: 'Path to the local export directory inside database-export (e.g., export_20251218_195500)'
        required: true
        default: 'latest'

jobs:
  deploy-with-db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: 'placeholder'
          if_key_exists: fail

      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ vars.REMOTE_HOST }} >> ~/.ssh/known_hosts

      - name: Transfer Files and Database
        run: |
          # Use the latest export if requested
          if [ "${{ github.event.inputs.export_path }}" = "latest" ]; then
            EXPORT_PATH=$(ls -td ./database-export/export_* 2>/dev/null | head -1)
          else
            EXPORT_PATH="./database-export/${{ github.event.inputs.export_path }}"
          fi

          if [ ! -d "$EXPORT_PATH" ]; then
            echo "âŒ Export path $EXPORT_PATH not found"
            exit 1
          fi

          echo "Using export: $EXPORT_PATH"

          # Transfer code
          rsync -avz --progress \
            -e "ssh -i ${{ secrets.SSH_PRIVATE_KEY }}" \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude 'dist' \
            --exclude '.git' \
            --exclude '*.log' \
            --exclude '.env' \
            ./backend/ ./frontend/ ${{ vars.REMOTE_USER }}@${{ vars.REMOTE_HOST }}:/opt/stratagem/

          # Transfer database export
          scp -r "$EXPORT_PATH" ${{ vars.REMOTE_USER }}@${{ vars.REMOTE_HOST }}:/opt/stratagem/database-import/

          # Transfer config
          scp docker-compose.prod.yml infrastructure/caddy/Caddyfile scripts/ ${{ vars.REMOTE_USER }}@${{ vars.REMOTE_HOST }}:/opt/stratagem/

      - name: Execute Restore and Deploy on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.REMOTE_HOST }}
          username: ${{ vars.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/stratagem
            
            # Identify the transfered export
            EXPORT_DIR=$(ls -td database-import/export_* 2>/dev/null | head -1)
            echo "Restoring from: $EXPORT_DIR"

            # Load env
            if [ -f .env ]; then export $(cat .env | grep -v '^#' | xargs); fi
            
            # Export repo info for docker-compose
            export GH_REPO_OWNER=${{ github.repository_owner }}
            export GH_REPO_NAME=${{ github.event.repository.name }}

            # Stop and remove existing containers
            docker compose -f docker-compose.prod.yml down

            # Restore PostgreSQL grc_platform
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'grc_platform' AND pid <> pg_backend_pid();"
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS grc_platform;"
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U postgres -d postgres -c "CREATE DATABASE grc_platform;"
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U postgres -d grc_platform < "$EXPORT_DIR/postgres_grc_platform.sql"

            # Login and Pull
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose -f docker-compose.prod.yml pull

            # Start
            docker compose -f docker-compose.prod.yml up -d
            
            # Final check
            docker compose -f docker-compose.prod.yml ps
